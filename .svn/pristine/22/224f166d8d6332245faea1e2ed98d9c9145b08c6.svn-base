/**
 *
 * @author gavin
 * @date 2014-4-18 下午2:29:35
 */
package com.ucf.customer.interceptor;

import java.io.PrintWriter;

import javax.annotation.Resource;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import com.ucf.platform.framework.core.log.UcfLogger;
import com.ucf.platform.framework.core.log.UcfLoggerFactory;
import com.ucf.platform.framework.redis.support.IAtomic;
import com.ucf.platform.framework.redis.support.ICache;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Repository;
import org.springframework.web.servlet.handler.HandlerInterceptorAdapter;

import redis.clients.jedis.Jedis;

import com.alibaba.fastjson.JSONObject;
import com.ucf.customer.pojo.UcfUser;
import com.ucf.customer.service.LoginService;
import com.ucf.customer.utils.exception.P2PCustomerException;

@Repository
public class SMSInterceptor extends HandlerInterceptorAdapter {
	private static UcfLogger LOGGER = UcfLoggerFactory.getLogger(SMSInterceptor.class);
	
	@Resource(name="redisKVManager")
	private ICache<String> cache = null;

	@Autowired
	private IAtomic<String> atomic = null;
	
	@Autowired
	private LoginService loginService;
	
	public boolean preHandle(HttpServletRequest request,
			HttpServletResponse response, Object handler) throws P2PCustomerException {
		try {
			String systemType = request.getParameter("systemType");
			if (!"cellNoP2P_RECHARGE_REQUEST_INF_customer".equals(systemType))
				return true;
			HttpSession session  = request.getSession();
			String jsonString = "";
			UcfUser user = (UcfUser)session.getAttribute("user");
			
			user = loginService.queryUserInfo(user.getUserId());
			
			try{
				//TODO
//				int times= 0;
//				if (null!=user) {
//					
//					if (jedis.exists(user.getCell()+user.getUserId())) {
//						times=Integer.parseInt(jedis.get(user.getCell()+user.getUserId())) ;
//					}
//					times++;
//					if (1==times) {
//						jedis.setex(user.getCell()+user.getUserId(), 3600, String.valueOf(times));
//					} else
//					jedis.incrBy(user.getCell()+user.getUserId(), 1);
//					
//					if (times>5) {
//						jsonString = JSONObject.toJSONString("1小时内最多连续发送5次"); 
//						PrintWriter out = response.getWriter();
//						out.print(jsonString);
//						out.flush();
//						out.close(); 
//						return false;
//					} else {
//						jsonString = JSONObject.toJSONString("验证码已发送"); 
//						PrintWriter out = response.getWriter();
//						out.print(jsonString);
//						out.flush();
//						out.close(); 
//					}
//				}
			}catch(Exception e){
				LOGGER.error(e.getMessage(), e);
			}finally{
			}
		} catch (Exception e) {
			LOGGER.error(e.getMessage(),e);
			request.setAttribute("msg", "操作失败");
			throw new P2PCustomerException();
		}
		return true;
	}

}
