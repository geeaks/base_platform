<%@ page contentType="text/html;charset=UTF-8" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<!DOCTYPE html>
<c:set var="basePath" value="${pageContext.request.contextPath }" />
<html>
<head>
<title>先锋支付</title>
<link rel="stylesheet" href="${staticMemberPath}/p2p/css/shouyingtai-pwd.css">
  <script src="${staticMemberPath}/js/jquery-1.11.1.min.js"></script>
<script src="${staticMemberPath}/js/commons/bootstrap.js"></script>
<script type="text/javascript" src="${staticMemberPath}/js/commons/jquery.validator.js"></script>
<script type="text/javascript" src="${staticMemberPath}/js/commons/local/zh_CN.js"></script>

<script type="text/javascript">
var dis = true;
function sendSMSNew(cellNo,smsType) {
	if(!dis){
	return ;
	}
	var param = {
			cellNo: cellNo,
			smsType : smsType
		};
	$.ajax({
		type:'POST',
		async:true,
		timeout:30000,
		url:'${basePath}/p2p/sendSms.htm',
		data:param,
		beforeSend:function() {
			$('#validPhoneCode').attr("disabled","disabled");
		},
		error:function(message){
			alert("短信验证码发送异常");
			$('#validPhoneCode').removeAttr("disabled");
		},
		success:function(result) {
			freezeTime();
		},
		dataType:"json"
	});
}

var sec = 120;
function freezeTime() {
	$('#validPhoneCode').attr("disabled","disabled");
	dis = false;
	for(var i=0;i<=sec;i++) { 
		setTimeout("updateTime("+ i + ")", i * 1000); 
	}
	setTimeout("defrostTime()",120000);
}
function defrostTime() {
	dis = true;
	$('#validPhoneCode').html('免费获取');
	$('#validPhoneCode').removeAttr("disabled");
}
function updateTime(i) {
	if(sec-i==0){
		defrostTime();
	}else{
		$('#validPhoneCode').html(sec-i+'秒后可再发送');
	}
}
</script>
</head>
<body>
    <div class="head">
    	<div class="container">
        	<img src="${staticMemberPath}/images/logo-zh.png" alt="...">
        </div>
    </div>
  	<div class="container">
		<div class="main-top border-yellow">
        	<div class=" mgl80"><img src="${staticMemberPath}/images/zhaohui1.png"></img></div>
               		<div class="main-body background-wite">
                        <form action="${basePath}/p2p/toSetPayPwd.do" method="post" id="postForm" name="postForm">
                        <input name="merchantId" type="hidden" value="${merchantId}"/>
						<input name="userId" type="hidden" value="${user.userId}"/>
                            <p id="bank_choose" style="display:none"><label for="name" >当前选择的银行卡 :</label>
                            <img width="125" height="28" id ="bank_image"
							alt='${bankCode}'
							src="${staticMemberPath}/new/images/logo/ICBC_1301.png" />
								<span>
                       			<img width="38" height="26" alt="CNCB" src="${staticMemberPath}/images/cxk.gif">
                    			</span>
                             </p>
                             
                            <p id="select_bank"><label for="name" >选择银行卡 :</label>
                               <select class="select-style w250" name="bankId" id="bankId" autocomplete="off">
									<c:forEach var="bank" items="${banks}" varStatus="xh">
										${bank.bankName}
										<option cell='${bank.phone}' value='${bank.id}'>(${bank.bankName})尾号${fn:substring(bank.cardNo, fn:length(bank.cardNo)-4, fn:length(bank.cardNo)) }</option>
									</c:forEach>
									<option cell=''  value="-1">自定义银行卡</option>  
                               </select>
                             </p>
                            <p><label for="name">银行卡号 :</label>
                               <input type="text" class="idbox w240" placeholder="请输入完整的银行卡号"  id="bankNo" name="bankNo"  />
                            </p>
                            <p><label for="name">真实姓名 :</label>
                                <input type="text" class="idbox w240" placeholder="请输入姓名"  maxlength="32" id="realName" name="realName"  />
							
							<p><label for="name">身份证号 :</label>
                                <input type="text" class="idbox w240" placeholder="请输入身份证号"  id="idNo" name="idNo"  />
							</p>
							
							<p id="cell_p" <c:if test="${!empty(banks)}"> style="display:none" </c:if> ><label for="name">手机号码:</label>
                             
                            <span id="cell_no" <c:if test="${empty(banks)}"> style="display:none" </c:if>></span>   
                            <input type="text" class="idbox w240" placeholder="请输入银行预留手机号"  id="cellNo" name="cellNo"  />
                            
                            </p>
                            <p id="code_p" <c:if test="${!empty(banks)}"> style="display:none" </c:if>><label for="name">短信验证码 :</label>
                                <input class="w50" type="text" id="vfyCode" name="vfyCode" tabindex="1" />
                                <a id="validPhoneCode" href="##"  onclick="send_sms_find_pwd();" class="auth">免费获取</a>
                            </p>
                            <a class="btn mt20 mgl113" onclick="$('#postForm').submit()" href="javascript:void(0)" data-toggle="modal">提交</a>
                            <a class="btn-normal mt20 mgl20" id="show_bank_select" href="javascript:void(0)" style="display:none">选择其他银行卡</a>
                            
                            
                            <!-- Modal      -->
                            <div class="modal fade" id="myModal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                              <div class="modal-dialog w780">
                                <div class="modal-content">
                                  <div class="modal-header">
                                    <h4 class="modal-title" id="myModalLabel">选择银行</h4>
                                  </div>
                                  <div class="modal-body">
                                    <ul class="list-bank">
                                        <li class="bank_li" alt='ICBC'>
                                       		<a class="bank-img">
                                               <img width="125" height="28" alt='ICBC'	src="${staticMemberPath}/new/images/logo/ICBC_1301.png" />
                                            </a>
                                        </li>
                                        <li class="bank_li"  alt='CEB' >
                                       		<a class="bank-img">
                                               <img width="125" height="28" alt='CEB'	src="${staticMemberPath}/new/images/logo/CEB_1301.png" />
                                            </a>
                                        </li>
                                        <li class="bank_li" alt='CCB'>
                                       		<a class="bank-img">
                                               <img width="125" height="28" alt='CCB'	src="${staticMemberPath}/new/images/logo/CCB_1301.png" />
                                            </a>
                                        </li>
                                        <li class="bank_li" alt='ABC'>
                                       		<a class="bank-img">
                                               <img width="125" height="28" alt='ABC'	src="${staticMemberPath}/new/images/logo/ABC_1301.png" />
                                            </a>
                                        </li>
                                        <li class="bank_li" alt='CIB'>
                                       		<a class="bank-img">
                                               <img width="125" height="28" alt='CIB'	src="${staticMemberPath}/new/images/logo/CIB_1301.png" />
                                            </a>
                                        </li>
                                        <li class="bank_li" alt='BOC'>
                                       		<a class="bank-img">
                                               <img width="125" height="28" alt='BOC'	src="${staticMemberPath}/new/images/logo/BOC_1301.png" />
                                            </a>
                                        </li>
                                        <li class="bank_li" alt='CNCB'>
                                       		<a class="bank-img">
                                               <img width="125" height="28" alt='CNCB'	src="${staticMemberPath}/new/images/logo/CNCB_1301.png" />
                                            </a>
                                        </li>
                                        <li class="bank_li" alt='BCCB'>
                                       		<a class="bank-img">
                                               <img width="125" height="28" alt='BCCB'	src="${staticMemberPath}/new/images/logo/BCCB_1301.png" />
                                            </a>
                                        </li>
                                        
                                        <div class="clear"></div>
                                       
                                      </ul>
                                  </div>
                                  <div  class="modal-footer">
                                    <button  id="bank_back" type="button" class="btn-normal mt20" data-dismiss="modal">返回</button>
                                    <div class="clear"></div>
                                  </div>
                                </div><!-- /.modal-content -->
                              </div><!-- /.modal-dialog -->
                            </div><!-- /.modal -->	
				</form>
			</div>
		</div>
		<footer class="container foot">
			<p>先锋支付版所有 2005-2013 ICP证：辽ICP备13000797号</p>
		</footer>
	</div>
</div>
<script language="javascript">
$(function(){
	$("#open1").click(function(){
	  $("#open1").hide();
	  $("#other-bank1,#close1").show();
	});
	
	$("#close1").click(function(){
	  $("#close1,#other-bank1").hide();
	  $("#open1").show();
	});
	
	
	$("#open2").click(function(){
	  $("#open2").hide();
	  $("#other-bank2,#close2").show();
	});
	
	$("#close2").click(function(){
	  $("#close2,#other-bank2").hide();
	  $("#open2").show();
	});
	
	
	$("#open3").click(function(){
	  $("#open3").hide();
	  $("#other-bank3,#close3").show();
	});
	
	$("#close3").click(function(){
	  $("#close3,#other-bank3").hide();
	  $("#open3").show();
	});
	
	
	$("#open4").click(function(){
	  $("#open4").hide();
	  $("#other-bank4,#close4").show();
	});
	
	$("#close4").click(function(){
	  $("#close4,#other-bank4").hide();
	  $("#open4").show();
	});
	
	if($("#bankId").val()=="-1"){
		$("#cell_no").hide();
		$("#cellNo").show();
		$("#cell_p").show();
		$("#code_p").show();
		$("#cellNo").val("");
		$('#myModal').modal("show")
		$("#show_bank_select").show();
	}
	else{
		$("#cell_no").hide();
		$("#cellNo").show();
		$("#cell_p").show();
		$("#code_p").show();
		$("#cellNo").val("");
	}
})

$("#postForm").validator({
	stopOnError: false,
		timely: 2,
		loadingMsg:'验证中...',
		msgStyle:"margin-top:0px;",
		validClass:"",
		msgMaker: function(opt){
			var t = '';
			if(opt.type=='error' || opt.key=="bankNo" || opt.type=="loading"){
				t = "tip";
			}
			return '<span class='+t+'><span></span>' + opt.msg + '</span>';
		},
		rules: {
			checkCardBIN: function(element){
				return checkBankCardBin("bankCardNo",element.value);
			}
		},
	fields: {
		'vfyCode': '验证码: required;',
		'bankNo': '银行卡号: required;',
		'bankId': '银行卡: required;',
		'bankNo': '银行卡号: required;checkCardBIN',
		'idNo': '身份证号: required;',
		'realName': '姓名: required;',
		'cellNo': '手机号: required;'
	}
});

function checkBankCardBin(name,value){
	var  res = $.ajax({
		url: '${basePath}/bank/checkCardBIN.do',
		type: 'post',
		data: name +'='+ value+"&cardType=1",
		dataType: 'json',
		success: function(d){
			$('#bankCode').val(d.bankCode);
			$('#bankName').val(d.bankName);
			if(d.bankCode=='CCB'){
				//$('.playPara').hide();
			}else{
				$('.playPara').show();
			}
			if(d.ok ==undefined){
				d.error ="您的银行卡号输入有误,请重新输入";
				return;
			}
			if(bank_select !='' && d.bankCode !=bank_select){
				d.error = d.ok +',银行卡类型错误';
			}
		}
	});
	return res;
}
//modify by gaoxiang 
$("#bank_back").click(function(){
	/* $("#bank_choose").hide();
	$("#bank_image").attr("src","${staticMemberPath}/new/images/logo/" + $(this).attr("alt") + "_1301.png");
	$("#bank_image").attr("alt",$(this).attr("alt"));
	$("#cell_p").hide();
	$("#code_p").hide();
	$("#select_bank").show();
	bank_select = '';
	$("#cellNo").hide();
	 $("#bankId").val(""); */
	location.reload();
	$('#myModal').modal("hide");
});
//add by gaoxiang 
$("#bankId").click(function(){
	if($(this).find("option:selected").attr("value")==-1){
		$('#myModal').modal("show");
	}
});
$("#bankId").change(function(){
	if($(this).find("option:selected").attr("value")==-1){
		$("#cell_no").hide();
		$("#cellNo").show();
		$("#cell_p").show();
		$("#code_p").show();
		$("#cellNo").val("");
		$('#myModal').modal("show")
		 $("#show_bank_select").show();
	}else if($(this).find("option:selected").attr("value") !=''){
		$("#cell_no").hide();
		$("#cellNo").show();
		$("#cell_p").show();
		$("#code_p").show();
		$("#cellNo").val("");
	}
	else{
		$("#cell_no").show();
		$("#cellNo").hide();
		$("#cell_p").hide();
		$("#code_p").hide();
		$("#cell_no").html($(this).find("option:selected").attr("cell"));
		$("#cellNo").val($(this).find("option:selected").attr("cell"));
	}
})

function  send_sms_find_pwd(){
	if($("#cellNo").val() != "" && $("#cellNo").val() !='请输入银行预留手机号'){
		sendSMSNew($("#cellNo").val(),0,'cellNoP2P_RECHARGE_REQUEST_INF_customer');
	}
}

//自定义选择的银行
var bank_select ='';
//点击返回
$("#show_bank_select").click(function(){
/* $("#bank_choose").hide();
$("#bank_image").attr("src","${staticMemberPath}/new/images/logo/" + $(this).attr("alt") + "_1301.png");
$("#bank_image").attr("alt",$(this).attr("alt"));
$("#select_bank").show();
bank_select = '';
$("#cellNo").hide();
$("#cell_p").hide();
$("#code_p").hide();
 $("#bankId").val("");
 $("#show_bank_select").hide(); */
 location.reload();
});

$(".bank_li").click(function(){
	$("#bank_choose").show();
	$("#bank_image").attr("src","${staticMemberPath}/new/images/logo/" + $(this).attr("alt") + "_1301.png");
	$("#bank_image").attr("alt",$(this).attr("alt"));
	$('#myModal').modal("hide");
	$("#select_bank").hide();
	$("#show_bank_select").show();
	bank_select = $(this).attr("alt");
});
</script>
</body>
</html>