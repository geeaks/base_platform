//调用JS

;(function($) {
    $(function() {
    	
    });

})(jQuery);

var validate = true;
function Form_Submit(form){
	try{
		var userpasswd = GetActiveX();
		var pass = userpasswd.GetValue();
		if(userpasswd.GetLength()==0){
			$("#pwdVali").val("");
			$("#pwd").val("");
		} else
		if(userpasswd.GetLength()<6||userpasswd.GetLength()>20){
			$("#pwdVali").val(1);
			$("#pwd").val(1);
		}else{
			$("#pwdVali").val(111111);
			$("#pwd").val(111111);
			var pass = userpasswd.GetValue();
			var len = userpasswd.GetLength();			
			document.getElementById("pwd").value = pass;
			document.getElementById("len").value = len;		
			var pcData = "";
			var isMac = (navigator.platform == "Mac68K") || (navigator.platform == "MacPPC") || (navigator.platform == "Macintosh") || (navigator.platform == "MacIntel");  
				
			if(!isMac){
				pcData = userpasswd.GetExtendData("random");
				document.getElementById("pcData").value = pcData;
				document.getElementById("isMac").value = "no";
			}else{
				document.getElementById("isMac").value = "yes";
			}			
			//$('#'+form).trigger("submit");
			//document.getElementById(form).submit();
		}
		$('#'+form).trigger("submit");
	}catch(err){
		$("#payPassword").val("");
	}
}

//密码控件回调函数，当在密码控件中按tab键时会调用该函数，实现在密码控件中也能按tab切换
function focusNext(obj){
    document.getElementById("btn_logon").focus();
}

function GetActiveX(){
	var userpasswd;
	var isMac = (navigator.platform == "Mac68K") || (navigator.platform == "MacPPC") || (navigator.platform == "Macintosh") || (navigator.platform == "MacIntel");  
	//判断是否为Mac OS，确定调用windows插件或Mac插件
	if (isMac){
		return document.getElementById("macPasswd");    //返回mac插件对象
	}else{
	//判断是否IE内核浏览器，调用相应的控件模块，embed标签对应的ID支持非IE内核浏览器
		userpasswd = document.getElementById("userpasswdNP");  //获取非IE内核插件对象
		try{
			if (!userpasswd || typeof userpasswd.GetValue == "undefined")
			{
				userpasswd = document.getElementById("userpasswd"); //获取IE内核插件对象
			}
		}catch(err){
			return null;
		}
	}		
	return userpasswd;
}

//为兼容Safari和Chrome不响应Embed标签的onblur事件
function checkLoseFocus(){
	if(detectBrowser().indexOf("Safari")>-1 || detectBrowser().indexOf("Chrome")>-1){
		loseFocus();
	}else{
		return false;
	}
}

//当控件失去焦点时，用Ajax连接服务器，判断密码强度
function loseFocus(){
	var baseUrl = $("#baseUrl").val();
	var userpasswd = GetActiveX();
	var pass = userpasswd.GetValue();
	var msg = "";
	//因为鼠标刚点击控件的时候会触发onblur事件，所以要先判断一下密码是否为空，不为空的情况利用AJAX向服务器验证密码有效性
	if(pass!=""){
		$.ajax({
			url:baseUrl+"/pwd/validatePwd.htm",
			data:{pwd:pass},
			dataType:"json",
			success:function(data){
				if($("span[for='pwd']").size()>0){
					$("span[for='pwd']").remove();
				}
				document.getElementById("pwd").value = pass;
				if(data.status==1){
					if($("span[for='pwd']").size()==0){
						var okEle = "<span class='msg-box n-right' style='' for='pwd'>"+
						"<span class='msg-wrap n-ok' role='alert'>"+
						"<span class='n-icon'></span>"+
						"<span class='n-msg'></span>"+
						"</span></span>";
						$("#myObj").append($(okEle));
					}else{
						$("span[for='pwd']").find(".msg-wrap").removeClass("n-error").addClass("n-ok");
						$("span[for='pwd']").find(".n-msg").empty();
					}
					
				}else{
					validate = false;
					msg = data.msg;
					var errorEle = "<span class='msg-box n-right' style='' for='pwd'>"+
					"<span class='msg-wrap n-error' role='alert'>"+
					"<span class='n-icon'></span>"+
					"<span class='n-msg'>"+msg+"</span>"+
					"</span></span>";
					$("#myObj").append($(errorEle));
				}
			}
		});
	}else{
		msg = "密码不能为空";
		var errorEle = "<span class='msg-box n-right' style='' for='pwd'>"+
		"<span class='msg-wrap n-error' role='alert'>"+
		"<span class='n-icon'></span>"+
		"<span class='n-msg'>"+msg+"</span>"+
		"</span></span>";
//		$(errorEle).filter(".n-msg").text(msg);
		$("#myObj").append($(errorEle));
	}
	
}

//创建Ajax
function createXMLHttp() {	
	var xmlHttp=null;
	if(window.ActiveXObject){
		xmlHttp = new ActiveXObject("Microsoft.XMLHTTP");
	}
	else if(window.ActiveXObject){
		xmlHttp = new ActiveXObject("Msxml2.XMLHTTP.4.0");
	}
	else if(window.ActiveXObject){
		xmlHttp = new ActiveXObject("Msxml2.XMLHTTP");
	}
	else if(window.XMLHttpRequest){
		xmlHttp = new XMLHttpRequest();
	}else{
		alert("创建Ajax失败");
	}
	if(!xmlHttp){
		alert("创建Ajax失败");
	}
	return xmlHttp;
}   



//检查操作系统类型   
function detectOS() {
    var sUserAgent = navigator.userAgent;   
    var isWin = (navigator.platform == "Win32") || (navigator.platform == "Windows");   
    var isMac = (navigator.platform == "Mac68K") || (navigator.platform == "MacPPC") || (navigator.platform == "Macintosh") || (navigator.platform == "MacIntel");   
    if (isMac) return "Mac";   
    var isUnix = (navigator.platform == "X11") && !isWin && !isMac;   
    if (isUnix) return "Unix";   
    var isLinux = (String(navigator.platform).indexOf("Linux") > -1);   
    if (isLinux) return "Linux";   
    if (isWin) {   
        var isWin2K = sUserAgent.indexOf("Windows NT 5.0") > -1 || sUserAgent.indexOf("Windows 2000") > -1;   
        if (isWin2K) return "Win2000";   
        var isWinXP = sUserAgent.indexOf("Windows NT 5.1") > -1 || sUserAgent.indexOf("Windows XP") > -1;   
        if (isWinXP) return "WinXP";   
        var isWin2003 = sUserAgent.indexOf("Windows NT 5.2") > -1 || sUserAgent.indexOf("Windows 2003") > -1;   
        if (isWin2003) return "Win2003";   
        var isWinVista= sUserAgent.indexOf("Windows NT 6.0") > -1 || sUserAgent.indexOf("Windows Vista") > -1;   
        if (isWinVista) return "WinVista";   
        var isWin7 = sUserAgent.indexOf("Windows NT 6.1") > -1 || sUserAgent.indexOf("Windows 7") > -1;   
        if (isWin7) return "Win7";   
    }   
    return "other";   
} 

function detectBrowser() {
//检查浏览器类型及版本号
		var Sys = {}; 
        var ua = navigator.userAgent.toLowerCase(); 
        var s; 
        (s = ua.match(/msie ([\d.]+)/)) ? Sys.ie = s[1] : 
        (s = ua.match(/firefox\/([\d.]+)/)) ? Sys.firefox = s[1] : 
        (s = ua.match(/chrome\/([\d.]+)/)) ? Sys.chrome = s[1] : 
        (s = ua.match(/opera.([\d.]+)/)) ? Sys.opera = s[1] : 
        (s = ua.match(/version\/([\d.]+).*safari/)) ? Sys.safari = s[1] : 0; 

        //以下进行测试 
        if (Sys.ie) return 'IE ' + Sys.ie; 
        else if (Sys.firefox) return 'Firefox ' + Sys.firefox; 
        else if (Sys.chrome) return 'Chrome ' + Sys.chrome; 
        else if (Sys.opera) return 'Opera ' + Sys.opera; 
        else if (Sys.safari) return 'Safari ' + Sys.safari;
}

//初始化mac插件
function initMacPwd(){
	var myDate = new Date();
	myDate.setMinutes(myDate.getMinutes()+myDate.getTimezoneOffset()-1500);
	var time;
	time = myDate.getFullYear().toString();
	if((myDate.getMonth()+1).toString().length==1){ time += "0" + (myDate.getMonth()+1).toString(); }else{ time += (myDate.getMonth()+1).toString(); }
	if((myDate.getDate()+1).toString().length==1){ time += "0" + (myDate.getDate()+1).toString(); }else{ time += (myDate.getDate()+1).toString(); }
	if((myDate.getHours()+1).toString().length==1){ time += "0" + (myDate.getHours()+1).toString(); }else{ time += (myDate.getHours()+1).toString(); }
	if((myDate.getMinutes()+1).toString().length==1){ time += "0" + (myDate.getMinutes()+1).toString(); }else{ time += (myDate.getMinutes()+1).toString(); }
	if((myDate.getSeconds()+1).toString().length==1){ time += "0" + (myDate.getSeconds()+1).toString(); }else{ time += (myDate.getSeconds()+1).toString(); }
	try{
		//alert(time);
		document.getElementById("macPasswd").initEtx(time);//初始化mac插件
	}catch(err){
		//若初始化mac插件失败，说明mac插件未安装，显示下载链接提示
		document.getElementById("myTip").style.display="block";
		document.getElementById("myObj").style.display="none";
		document.getElementById("mac").style.display="none";
	}
	
}

//清空
function clearPass(){
		GetActiveX().RealInput = "";
}

//机器指纹
function getPC(){
	var isMac = (navigator.platform == "Mac68K") || (navigator.platform == "MacPPC") || (navigator.platform == "Macintosh") || (navigator.platform == "MacIntel");  
	//判断是否为Mac OS
	if (isMac){
		alert("MAC OS 不支持机器指纹获取");
	}else{
		alert("机器指纹(已加密)：" + GetActiveX().GetExtendData("random"));
	}	
}


window.onload = function showObj(){
	var sUserAgent = navigator.userAgent;  
	//根据操作系统类型，显示相应的插件
	if ("Mac"==detectOS()){
		document.getElementById("myTip").style.display="none";
		document.getElementById("myObj").style.display="none";
		document.getElementById("mac").style.display="block";			
		setTimeout(initMacPwd,1000);  //初始化mac插件，初始化时设置了延时，否则可能也现页面插件还没加载完初始化失败
	}else{
		var userpasswd = GetActiveX();	
		//判断插件是否已经安装，如果已安装，则显示插件，未安装则显示下载链接提示
		if (userpasswd != null && userpasswd.Working==true){
			document.getElementById("myTip").style.display="none";
			document.getElementById("myObj").style.display="block";
			document.getElementById("mac").style.display="none";
		}else{
			document.getElementById("myTip").style.display="block";
			document.getElementById("myObj").style.display="none";
			document.getElementById("mac").style.display="none";
		}
	}  	
};