<%@ page contentType="text/html;charset=UTF-8" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<c:set var="basePath" value="${pageContext.request.contextPath }" scope="application"/>
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>找回支付密码</title>
	<meta name="description" content="">
	<meta name="author" content="">
	<META http-equiv="X-UA-Compatible" content="IE=9" >
	<link href="${staticMemberPath}/css/shouyintai.css" rel="stylesheet">
	<script src="${staticMemberPath}/js/jquery-1.11.1.min.js"></script>
	<jsp:include page="../common/resource_js.jsp"/>
</head>
<body>
	<div class="head">
		<div class="container">
			<img src="${staticMemberPath}/images/findpaypwd_logo.png" alt="...">
		</div>
	</div>
	<div class="container">
		<div class="main-top border-yellow find">
			<div class="guide">
				<img src="${staticMemberPath}/images/find_paypwd1.png"></img>
			</div>
			<c:set var="cardLength" value="${fn:length(bankCard.cardNo)}" />
			<div class="find-inf-yj"><span class="red">请输入您尾号为（ ${fn:substring(bankCard.cardNo, cardLength-4, cardLength)} ）的${bankCard.bankName}的卡信息</span></div>
			<div class="main-body background-wite">
				<form id="identityForm" name="identityForm" class="form-common" action="${basePath}/p2p/toSetPasswd.do" method="post" data-validator-option="{theme:'ucfgroup_effect',timely:2}">
					<input name="merchantId" type="hidden" value="${merchantId}"/>
					<input name="userId" type="hidden" value="${user.userId}"/>
					<input name="cellNo" type="hidden" value="${user.cell}"/>
					<input name="bankId" type="hidden" value="${bankCard.id}"/>
					<input id="bankType" name="bankType" type="hidden" value="${bankCard.bankId}"/>
					<input id="bankCode" name="bankCode" type="hidden">
					<input id="bankName" name="bankName" type="hidden">
					<input id="issure" name="issure" type="hidden">
					<p><label for="bankCardNo">银行卡号 :</label>
						<input id="bankCardNo" name="bankCardNo" maxlength="23" type="text" tabindex="1" data-tip="请输入您的储蓄卡卡号"/>
					</p>
					<p><label for="realName">真实姓名 :</label>
						<input id="realName" name="realName" maxlength="32" type="text" tabindex="1" data-tip="请输入您的真实姓名"/>
					</p>
					<p><label for="certNo">身份证号 :</label>
						<input id="certNo" name="certNo" maxlength="18" type="text" tabindex="2" data-tip="请输入您的身份证号" />
					</p>
					<p><label for="name">手机号码 :</label>
						${user.cell}
					</p>
					<p><label for="vercode">短信验证码 :</label>
						<input id="vercode" name="vercode" type="text" data-tip="请输入短信验证码" maxlength=6 tabindex="3" style="width:105px; vertical-align: middle;"/>
						<input id="validPhoneCode" type="button" onclick="sendSMS();" 
							class="auth" style="width:100px;color:#666;padding:0" value="获取验证码"/>
					</p>
					<c:if test="${msg ne null}">
						<p>
							<label for="errormsg"></label>
							<span style="color: red">${msg}</span>
						</p>
					</c:if>
					<a class="btn mt20 mgl113" onclick="subForm()" href="javascript:void(0)" data-toggle="modal">下一步</a>
				</form>
			</div>
		</div>
		<footer class="container foot">
			<p>先锋支付版所有 2005-2013 ICP证：辽ICP备13000797号</p>
		</footer>
	</div>
</div>
<link href="${staticMemberPath}/css/ucfgroup-nicevalidator-extends.css" rel="stylesheet">
<script language="javascript">
	function subForm(){
		var form=document.identityForm;
		if($('#identityForm').isValid()){
			form.submit();
		}
	}
	$(document).ready(function() {
		$("#validPhoneCode").removeAttr("disabled");
		$('#identityForm').validator({
			stopOnError: false,
			timely: true,
			rules: {
				card: function(element, params){
					var card = element.value.replace(/\s/g,'');
					if(/\D/g.test(card)){
						return '无法识别您的卡号，请填写正确的银行卡卡号';
					}
				},
				checkCard: function(element, params){
					var card = element.value.replace(/\s/g,'');
					if(!/^\d{12,19}$/g.test(card)){
						return "银行卡号是12－19位数字";
					}
					$('#cardNo').val(card);
					return true;
				},
				certNo: function(element, params){
					//内部的this指向的是当前实例，可以直接调用所有方法，这里调用了test方法
					return idCardValidate() || '请输入有效的身份证号';
				},
				nameCheck: function(element) {
					var reg = /[!@#$%^&*\(\)\-\+\=\_~\|,\?\{\}\[\].]+/;
					if (reg.test(element.value)){
						return '名字不可包含特殊字符';
					}
					obj= element.value.replace(/\s+/g,"");
					$("#realName").val(obj);
					return /^(?:[\u4E00-\u9FFF]{2,5})$/.test(element.value) || '请输入中文姓名';
				}
			},
			fields: {
				'bankCardNo':{
					rule:'required;card;checkCard;',
					msg:{required: "银行卡号不能为空"}
				},
				'realName':{
					rule:'required;',
					msg:{required: "姓名不能为空"}
				},
				'certNo':{
					rule:'required;certNo;',
					msg:{required: "身份证号不能为空"}
				},
				'vercode':{
					rule:'required;',
					msg:{required: "验证码不能为空"}
				}
			}
		});
	});
	var Wi = [ 7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2, 1 ];// 加权因子
	var ValideCode = [ 1, 0, 10, 9, 8, 7, 6, 5, 4, 3, 2 ];// 身份证验证位值.10代表X
	function idCardValidate() {   
		var idCard = document.getElementById("certNo").value;
		idCard = trim(idCard.replace(/ /g, ""));
		if (idCard.length == 15) {
			return isValidityBrithBy15IdCard(idCard);
		} else if (idCard.length == 18) {
			var a_idCard = idCard.split("");// 得到身份证数组
			if(isValidityBrithBy18IdCard(idCard)&&isTrueValidateCodeBy18IdCard(a_idCard)){
				return true;
			}else {
				return false;
			}
		} else {
			return false;
		};
	}
	/**  
	 * 判断身份证号码为18位时最后的验证位是否正确  
	 * @param a_idCard 身份证号码数组  
	 * @return  
	 */
	function isTrueValidateCodeBy18IdCard(a_idCard) {   
		var sum = 0; // 声明加权求和变量   
		if (a_idCard[17].toLowerCase() == 'x') {   
			a_idCard[17] = 10;// 将最后位为x的验证码替换为10方便后续操作   
		}
		for ( var i = 0; i < 17; i++) {   
			sum += Wi[i] * a_idCard[i];// 加权求和   
		}
		valCodePosition = sum % 11;// 得到验证码所位置   
		if (a_idCard[17] == ValideCode[valCodePosition]) { 
			return true;
		} else {
			return false;
		};
	}

	/**  
	  * 验证18位数身份证号码中的生日是否是有效生日  
	  * @param idCard 18位书身份证字符串  
	  * @return  
	  */  
	function isValidityBrithBy18IdCard(idCard18){   
	    var year =  idCard18.substring(6,10);   
	    var month = idCard18.substring(10,12);   
	    var day = idCard18.substring(12,14);   
	    var temp_date = new Date(year,parseFloat(month)-1,parseFloat(day));   
	    // 这里用getFullYear()获取年份，避免千年虫问题   
	    if(temp_date.getFullYear()!=parseFloat(year)   
	          ||temp_date.getMonth()!=parseFloat(month)-1   
	          ||temp_date.getDate()!=parseFloat(day)){ 
	            return false;   
	    }else{  
	        return true;   
	    }   
	}   
	  /**  
	   * 验证15位数身份证号码中的生日是否是有效生日  
	   * @param idCard15 15位书身份证字符串  
	   * @return  
	   */  
	  function isValidityBrithBy15IdCard(idCard15){
	      var year =  idCard15.substring(6,8);
	      var month = idCard15.substring(8,10);
	      var day = idCard15.substring(10,12);
	      var temp_date = new Date(year,parseFloat(month)-1,parseFloat(day));
	      // 对于老身份证中的你年龄则不需考虑千年虫问题而使用getYear()方法
	      if(temp_date.getYear()!=parseFloat(year)
	              ||temp_date.getMonth()!=parseFloat(month)-1
	              ||temp_date.getDate()!=parseFloat(day)){
	                return false;
	        }else{
	            return true;
	        }
	  }   
	//去掉字符串头尾空格
	function trim(str) {
		return str.replace(/(^\s*)|(\s*$)/g, "");
	}
	function sendSMS(){
		sendSMSNew('','0');
	};
</script>
<script src="${staticMemberPath}/js/jquery.validator.js" type="text/javascript"></script>
<script src="${staticMemberPath}/js/ucfgroup-nicevalidator-extends.js" type="text/javascript"></script>
</body>
</html>