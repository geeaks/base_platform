<%@ page contentType="text/html;charset=UTF-8" %>
<!DOCTYPE html>
<jsp:include page="../p2p/commons/resource_meta.jsp"/>
<jsp:include page="/WEB-INF/views/jsp/common/common.jsp"/>
<html>
<head>
<title>先锋支付</title>
<jsp:include page="commons/resource_css.jsp"/>
<jsp:include page="commons/resource_js.jsp"/>
  <%
     String userName = (String)request.getAttribute("userName");
     String certNo = (String)request.getAttribute("certNo");
     String mobile = (String)request.getAttribute("mobile");
     String cell = (String)request.getAttribute("cell");
     String cardNo = (String)request.getAttribute("cardNo");
     String cardNum = (String)request.getAttribute("cardNo");
%>
</head>
<body>
<section>
    <div class="box">
    	<div class="host_title">资金托管平台<span>修改银行卡</span></div>
        <div class="main">
        	<div class="box_title pl20"><em class="f18">我的银行卡</em></div>
            <div class="w902 mauto">
                <div class="h_border_b">
                    <table>
                    	<colgroup>
                        	<col width="155">
                            <col width="745">
                        </colgroup>
                        <tbody class="h_open_tab f14">
                        	<tr>
                            	<th>姓名：</th>
                                <td>
                                	${requestScope.HID_user["realName"] }
                                </td>
                            </tr>
                            <tr>
                            	<th>身份证： </th>
                                <td>
                                	${requestScope.HID_user["certNo"] }
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="pt30 pb100">
                	<p class="f14"><strong class="color-yellow1">请输入您要变更的银行卡号</strong> </p>
                	<form action="${basePath}/bank/modify.htm" method="post">
                    	<table width="100%">
	                    	<colgroup>
	                        	<col width="155">
	                            <col width="745">
	                        </colgroup>
	                        <tbody class="h_open_tab f14">
	                        	<tr>
	                            	<th>此借记卡用于：</th>
	                                <td>提现</td>
	                                <!--<td>快捷支付</td>-->
	                            </tr>
	                        	<tr>
	                            	<th>银行卡号：</th>
	                                <td>
	                                	<input type="text" id="cardNo" name="cardNo" class="h_open_ipt" maxlength="25" disabled="disabled" value="${requestScope.HID_bankCard['cardNo'] }">
	                                	<i BINinfo></i>
	                                    <input type="hidden" id="cardNum" name="cardNum"  value="${requestScope.HID_bankCard['cardNo'] }">
	                                    <input type="hidden" id="bankCode" name="bankCode">
	                                    <input type="hidden" id="bankName" name="bankName" >
	                                    <input type="hidden" id="prov" name="prov" >
	                                    <input type="hidden" id="cityna" name="cityna" >
	                                    <input type="hidden" id="branchName" name="branchName" >
	                                </td>
	                            </tr>
	                           <tr>
	                            	<th>开户行地址：</th>
	                                <td>
	                                	<select id="province" name="province" class="h_open_sel">
	                                    	<option>安徽省</option>
	                                        <option>山东省</option>
	                                        <option>浙江省</option>
	                                        <option>海南省</option>
	                                        <option>广东省</option>
	                                    </select>
	                                    <label class="h_open_lab" for="province">省</label>
	                                    <select id="city" class="h_open_sel">
	                                    	<option>安庆市</option>
	                                        <option>枣庄市</option>
	                                        <option>广州市</option>
	                                        <option>海口市</option>
	                                        <option>杭州市</option>
	                                    </select>
	                                    <label class="h_open_lab" for="city">地区</label>
	                                    <select class="h_open_sel usefor_tx_select" id="branchBank" name="branchBank">
	                                    	<option>中国工商银行股份有限公司</option>
	                                        <option>中国工商银行股份有限公司</option>
	                                        <option>中国工商银行股份有限公司</option>
	                                        <option>中国工商银行股份有限公司</option>
	                                        <option>中国工商银行股份有限公司</option>
	                                    </select>
	                                    <label class="h_open_lab usefor_tx_select" for="branchBank">支行</label>
	                                </td>
	                            </tr>
	                            <tr>
	                            	<th>手机号码：</th>
	                                <td>
	                                	<label class="h_open_lab">${requestScope.HID_user["cell"] }</label>
	                                	<input id="validPhoneCode" type="button" onclick="sendSMS(${requestScope.HID_user['cell'] },1,'cellNoP2P_RECHARGE_REQUEST_INF_customer');" class="send_vfycode h_open_ipt h_open_btn h_checkcode_btn ml10" value="获得短信验证码"><i id="sendSMSTipI"
													class="formvalidError formvalidError1" style="display: none;"></i><em id="sendSMSTipEm" class="f12"></em>
	                                </td>
	                            </tr>
	                            <tr>
	                            	<th>短信验证码：</th>
	                                <td>
	                                	<input type="text" id="vercode" name="vercode" class="h_open_ipt" placeholder="请输入短信验证码">
	                                </td>
	                            </tr>
	                            <tr>
	                            	<th>请输入支付密码：</th>
	                                <td>
	                                	<input type="password" id="paypwd" name="paypwd" class="h_open_ipt" placeholder="请输入您的密码">
	                                </td>
	                            </tr>
	                            <tr>
	                            	<th></th>
	                                <td>
	                                	<input type="submit" value="提交" class="but-gray but-yellow w130 mr15">
	                                    <a href="${basePath}/login/toManageBankCard.do" class="but-gray but-blue w100 ml20">返回上一步</a>
	                                </td>
	                            </tr>
	                        </tbody>
	                    </table>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>
	<script type="text/javascript">
	$(document).ready(function(){//这个就是jQueryready yuchao@ucfgroup.com
		
		getBankCardBIN();
		getBankCardNo(1);
		$("#province").change(function(){
			var prov = $("#province").find("option:selected").text();
			$('#prov').val(prov);
			getBankCardNo(2);
		});
		$("#city").change(function(){
			var cy = $("#city").find("option:selected").text();
			$('#cityna').val(cy);
			getBankCardNo(3);
		});
		$("#branchBank").change(function(){
			var bk = $("#branchBank").find("option:selected").text();
			$('#branchName').val(bk);
		});
	});
	function getBankCardBIN(){ //函数 getBankCardBIN(); 
		var cardNo = $("#cardNum").val();//取框中的卡号 
		$.ajax({ //一个Ajax过程 
			 type: "post", //以post方式与后台沟通 
			 url : "${basePath}/login/getBankCardBIN.do", //与此后台沟通 
			 dataType:'json',
			 data: 'bankCardNo='+cardNo,
			 async:false,
			 success: function(json){
				 var obj=json.bankName;
			// alert(json.bankName+'\n'+json.bankCode);
			 if(obj.indexOf("不存在")>=0||obj.indexOf("失败")>=0){
				 $('#BINinfo').html("<em class=\"color-yellow1\">"+obj+"</em>");
				 $('#BINinfo').addClass("formvalidError formvalidError1");
			 }else{
				 $('#BINinfo').html(json.bankName);
				 $('#bankName').val(json.bankName);
				 $('#bankCode').val(json.bankCode);
				 $('#BINinfo').addClass("successValid1"); 

			 };
			},
			error: function(json){
			 $('#BINinfo').html("<em class=\"color-yellow1\">"+json+"</em>");
			 $('#BINinfo').addClass("formvalidError");
			}
		});
	}
	///////////////////////////////////////////////////////////////
	function getBankCardNo(type){
		var cardNo = $("#cardNum").val();//取框中的卡号
		var param = "";
		if(type == 1){
			param = 'bankCardNo='+cardNo;
		}
		if(type == 2){
			var provinceCode = $("#province").val();
			param = 'bankCardNo='+cardNo+"&ProvinceCode="+provinceCode;
		}
		if(type == 3){
			var provinceCode = $("#province").val();
			var cityCode = $("#city").val();
			param = 'bankCardNo='+cardNo+"&ProvinceCode="+provinceCode+
					'&CityCode='+cityCode;
		}
		var result = $.ajax({ //一个Ajax过程 
			 type: "post", //以post方式与后台沟通 
			 url : "${basePath}/bank/getBankCardNo.do", //与此后台沟通 
			 dataType:'json',
			 data: param,
			 async:false,
			 success: function(json){
				 
			 if(json){
			 	var json = eval(json);
				
				var optionstring = "";					
				for(var i=0;i<json.length;i++)
				{
					if(type == 1){
						optionstring += "<option value=\""+ json[i].provinceCode +"\" >"+ json[i].provinceName +"</option>";
						$('#province').html(optionstring);
					}
					if(type == 2){
						optionstring += "<option value=\""+ json[i].cityCode +"\" >"+ json[i].cityName +"</option>";
						$('#city').html(optionstring);
					}
					if(type == 3){
						optionstring += "<option value=\""+ json[i].subBankIdentity +"\" >"+ json[i].subBankName +"</option>";
						$('#branchBank').html(optionstring);
					}
				}
				
				 
				return json;
			 	//$('#BINinfo').html("");
			 }else{
				 $('#BINinfo').html("");
			 };
			},
			error: function(json){
			 $('#BINinfo').html("");
			}
		});
		
	}
	
	 window.onload =function() {
			var prov = $("#province").find("option:selected").text();
			$('#prov').val(prov);
			var cy = $("#city").find("option:selected").text();
			$('#cityna').val(cy);
			var bk = $("#branchBank").val();
			$('#branchName').val(bk);
         document.getElementById("cardNum").onkeyup =function() {
             this.value =this.value.replace(/\s/g,'').replace(/(\d{4})(?=\d)/g,"$1 ");;
         };
     };
	</script>
</body>
</html>