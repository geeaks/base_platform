package com.ucf.customer.interceptor;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.method.HandlerMethod;
import org.springframework.web.servlet.handler.HandlerInterceptorAdapter;

import com.ucf.customer.security.Enumbase_platformUserType;
import com.ucf.customer.security.base_platformAccess;
import com.ucf.customer.security.base_platformAgent;

public class LoginInterceptor extends HandlerInterceptorAdapter {
	
	
	
	@Value("#{settings['static.res.path']}")
	private String staticbase_platformPath;
	
	@Override
	public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
		HandlerMethod handler2 = (HandlerMethod) handler;
		base_platformAccess base_platformAccess = handler2.getMethodAnnotation(base_platformAccess.class);
		HttpSession session  = request.getSession();
		session.setAttribute("staticbase_platformPath", staticbase_platformPath);
		if (null == base_platformAccess) {
			return true;
		}
		base_platformAgent base_platformAgent = (base_platformAgent) session.getAttribute("base_platformAgent");

		if (base_platformAgent == null) {
			// 未登录，则除非包含base_platformUserType.Visitor,否则抛出需要登录异常
			for (Enumbase_platformUserType t : base_platformAccess.value()) {
				if (t == Enumbase_platformUserType.Visitor) {
					// 可以访问
					return true;
				}
			}
			response.sendRedirect("../login/index.htm?redirectUrl="	+ request.getRequestURL());
			return false;
		} else {
			for (Enumbase_platformUserType t : base_platformAccess.value()) {
				if (t == base_platformAgent.getUserType()) {
					
//					if (!request.getRequestURI().matches(".*/bank/firstaddbank.htm") && !base_platformAgent.isBindCard()) {
//						response.sendRedirect("../bank/firstaddbank.htm");
//						return false;
//					}
					return true;
				}
			}
			response.sendRedirect("../login/index.htm?redirectUrl=" + request.getRequestURL());
			return false;
		}

	}

	// public boolean preHandle(HttpServletRequest request,
	// HttpServletResponse response, Object handler) throws Exception {
	//
	// request.setCharacterEncoding("UTF-8");
	// response.setCharacterEncoding("UTF-8");
	// response.setContentType("text/html;charset=UTF-8");
	// RedisSession session = redisSessionFactory.getSession(request, response);
	// String project = "/base_platform/";
	// // 后台session控制
	// String[] noFilters = new String[] {
	// "p2p" ,
	// "logout",
	// "login/checkUserExists.do",
	// "login/checkLogin.do",
	// "login/findPwdByPhonePre.do",
	// "login/findPwdByPhone.do",
	// "login/pwdModTelSuc.do",
	// "idcode.do", "checkCardBIN.do" , "login/" , "reg.*" , "sms.*" ,
	// "checkIdcode.do",
	// };
	// String uri = request.getRequestURI();
	// boolean beFilter = true;
	// if (uri.indexOf("p2p")>0) {
	// beFilter = false;
	// } else {
	// for (String s : noFilters) {
	// if ((uri).matches(project+s)) {
	// beFilter = false;
	// break;
	// }
	// }
	// }
	// if (beFilter) {
	// Object obj = session.getAttribute(
	// Constants.USER_LOGIIN_STATUS);
	// if (null == obj || Constants.USER_LOGIIN_STATUS_NO.equals(obj)) {
	// // 未登录
	// response.sendRedirect("/base_platform/login/?redirectUrl="+request.getRequestURL());
	// return false;
	// }
	// }
	//
	// return super.preHandle(request, response, handler);
	// }

}
