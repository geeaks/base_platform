package com.ucf.customer.interceptor;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.method.HandlerMethod;
import org.springframework.web.servlet.handler.HandlerInterceptorAdapter;

import com.ucf.customer.security.EnumMemberUserType;
import com.ucf.customer.security.MemberAccess;
import com.ucf.customer.security.MemberAgent;

public class LoginInterceptor extends HandlerInterceptorAdapter {
	
	
	
	@Value("#{settings['static.res.path']}")
	private String staticMemberPath;
	
	@Override
	public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
		HandlerMethod handler2 = (HandlerMethod) handler;
		MemberAccess memberAccess = handler2.getMethodAnnotation(MemberAccess.class);
		HttpSession session  = request.getSession();
		session.setAttribute("staticMemberPath", staticMemberPath);
		if (null == memberAccess) {
			return true;
		}
		MemberAgent memberAgent = (MemberAgent) session.getAttribute("MemberAgent");

		if (memberAgent == null) {
			// 未登录，则除非包含MemberUserType.Visitor,否则抛出需要登录异常
			for (EnumMemberUserType t : memberAccess.value()) {
				if (t == EnumMemberUserType.Visitor) {
					// 可以访问
					return true;
				}
			}
			response.sendRedirect("../login/index.htm?redirectUrl="	+ request.getRequestURL());
			return false;
		} else {
			for (EnumMemberUserType t : memberAccess.value()) {
				if (t == memberAgent.getUserType()) {
					
//					if (!request.getRequestURI().matches(".*/bank/firstaddbank.htm") && !memberAgent.isBindCard()) {
//						response.sendRedirect("../bank/firstaddbank.htm");
//						return false;
//					}
					return true;
				}
			}
			response.sendRedirect("../login/index.htm?redirectUrl=" + request.getRequestURL());
			return false;
		}

	}

	// public boolean preHandle(HttpServletRequest request,
	// HttpServletResponse response, Object handler) throws Exception {
	//
	// request.setCharacterEncoding("UTF-8");
	// response.setCharacterEncoding("UTF-8");
	// response.setContentType("text/html;charset=UTF-8");
	// RedisSession session = redisSessionFactory.getSession(request, response);
	// String project = "/member/";
	// // 后台session控制
	// String[] noFilters = new String[] {
	// "p2p" ,
	// "logout",
	// "login/checkUserExists.do",
	// "login/checkLogin.do",
	// "login/findPwdByPhonePre.do",
	// "login/findPwdByPhone.do",
	// "login/pwdModTelSuc.do",
	// "idcode.do", "checkCardBIN.do" , "login/" , "reg.*" , "sms.*" ,
	// "checkIdcode.do",
	// };
	// String uri = request.getRequestURI();
	// boolean beFilter = true;
	// if (uri.indexOf("p2p")>0) {
	// beFilter = false;
	// } else {
	// for (String s : noFilters) {
	// if ((uri).matches(project+s)) {
	// beFilter = false;
	// break;
	// }
	// }
	// }
	// if (beFilter) {
	// Object obj = session.getAttribute(
	// Constants.USER_LOGIIN_STATUS);
	// if (null == obj || Constants.USER_LOGIIN_STATUS_NO.equals(obj)) {
	// // 未登录
	// response.sendRedirect("/member/login/?redirectUrl="+request.getRequestURL());
	// return false;
	// }
	// }
	//
	// return super.preHandle(request, response, handler);
	// }

}
